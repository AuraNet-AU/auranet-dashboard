{% extends "base.html" %}

{% block container_width %}900px{% endblock %}
{% block content_width %}900px{% endblock %}

{% block extra_styles %}
  .device-card {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s;
    border: 2px solid transparent;
  }

  .device-card:hover {
    border-color: #e2e8f0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .device-icon {
    width: 52px;
    height: 52px;
    border-radius: 12px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    flex-shrink: 0;
  }

  .device-name {
    font-weight: 700;
    color: #1e293b;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .device-name .edit-btn {
    opacity: 0;
    transition: opacity 0.2s;
    color: #94a3b8;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 0.875rem;
  }

  .device-card:hover .device-name .edit-btn { opacity: 1; }
  .device-name .edit-btn:hover { color: var(--aura-primary); }

  .device-meta { font-size: 0.8125rem; color: #64748b; margin-top: 0.125rem; }
  .device-meta .separator { margin: 0 0.5rem; color: #cbd5e1; }
  .device-queries { font-size: 0.75rem; color: #94a3b8; margin-top: 0.375rem; }

  .info-box {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    border-left: 4px solid #3b82f6;
  }

  .info-box.warning {
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
    border-left-color: #f59e0b;
  }

  .info-box h4 { font-size: 0.9375rem; font-weight: 700; color: #1e40af; margin-bottom: 0.375rem; display: flex; align-items: center; }
  .info-box.warning h4 { color: #92400e; }
  .info-box p { font-size: 0.8125rem; color: #1e3a8a; margin: 0; line-height: 1.5; }
  .info-box.warning p { color: #78350f; }

  .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
  .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

  .modal-content { border-radius: 16px; border: none; }
  .modal-header { border-bottom: 1px solid #f1f5f9; padding: 1.25rem 1.5rem; }
  .modal-body { padding: 1.5rem; }
  .modal-footer { border-top: 1px solid #f1f5f9; padding: 1rem 1.5rem; }

  .form-label { font-weight: 600; color: #374151; font-size: 0.875rem; }

  .form-control {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-size: 0.9375rem;
  }

  .form-control:focus {
    border-color: var(--aura-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .device-icon-preview {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: var(--aura-primary);
    margin: 0 auto 1rem;
  }

  .icon-selector { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-top: 0.75rem; }

  .icon-option {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
  }

  .icon-option:hover { border-color: var(--aura-primary); color: var(--aura-primary); }

  .icon-option.selected {
    border-color: var(--aura-primary);
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    color: var(--aura-primary);
  }
{% endblock %}

{% set active_page = 'devices' %}

{% block content %}

  <div class="info-box">
    <h4><i class="bi bi-info-circle-fill me-2"></i>Your Connected Devices</h4>
    <p>
      These are all devices that have connected to your network. Click the <i class="bi bi-pencil"></i> icon to give each device a friendly name so you can easily identify them (e.g., "Dad's iPhone", "Living Room TV").
    </p>
  </div>

  <div class="aura-card">
    <div class="aura-card-header">
      <div class="header-icon" style="background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%); color: #2563eb;">
        <i class="bi bi-laptop"></i>
      </div>
      <h2>Network Devices</h2>
      <span class="badge bg-primary ms-auto" style="font-size: 0.75rem;">{{ devices|length }} devices</span>
    </div>
    <div class="aura-card-body">

      {% if devices %}
        {% for device in devices %}
        <div class="device-card">
          <div class="d-flex align-items-center gap-3">
            <div class="device-icon" style="color: {{ '#22c55e' if device.queries > 1000 else '#6366f1' if device.queries > 100 else '#94a3b8' }};">
              <i class="bi bi-{{ device.icon if device.icon else 'laptop' }}"></i>
            </div>
            <div class="flex-grow-1 min-width-0">
              <div class="device-name">
                <span class="text-truncate">{{ device.custom_name if device.custom_name else device.name }}</span>
                <i class="bi bi-pencil edit-btn"
                   data-bs-toggle="modal"
                   data-bs-target="#renameModal"
                   data-mac="{{ device.mac }}"
                   data-name="{{ device.custom_name if device.custom_name else device.name }}"
                   data-icon="{{ device.icon if device.icon else 'laptop' }}"
                   title="Rename device"></i>
              </div>
              <div class="device-meta">
                <span><i class="bi bi-hdd-network me-1"></i>{{ device.ip }}</span>
                {% if device.vendor and device.vendor != device.name and device.vendor != device.custom_name %}
                  <span class="separator">â€¢</span>
                  <span>{{ device.vendor }}</span>
                {% endif %}
              </div>
              <div class="device-queries">
                <i class="bi bi-activity me-1"></i>{{ "{:,}".format(device.queries) }} queries
              </div>
            </div>
            <button class="btn btn-sm btn-outline-primary d-none d-md-inline-flex align-items-center"
                    data-bs-toggle="modal"
                    data-bs-target="#renameModal"
                    data-mac="{{ device.mac }}"
                    data-name="{{ device.custom_name if device.custom_name else device.name }}"
                    data-icon="{{ device.icon if device.icon else 'laptop' }}">
              <i class="bi bi-pencil me-1"></i>Rename
            </button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="bi bi-wifi-off"></i>
          <h5>No Devices Found</h5>
          <p class="mb-0">Devices will appear here once they connect to your network and make DNS requests. This usually happens within a few minutes of the device connecting.</p>
        </div>
      {% endif %}

    </div>
  </div>

  <div class="info-box warning">
    <h4><i class="bi bi-stars me-2"></i>Coming Soon: Per-Device Filtering</h4>
    <p>
      In a future update, you'll be able to assign different protection levels to different devices. For example, maximum protection for kids' tablets and standard protection for adult devices. Currently, the protection level set on the Home page applies to all devices.
    </p>
  </div>

{% endblock %}

{% block scripts %}
<!-- RENAME MODAL (outside content div so it's not clipped) -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="renameModalLabel">
          <i class="bi bi-pencil-square me-2 text-primary"></i>Rename Device
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="" id="renameForm">
        <div class="modal-body">
          <div class="device-icon-preview" id="iconPreview"><i class="bi bi-laptop"></i></div>
          <div class="mb-3">
            <label for="deviceName" class="form-label">Device Name</label>
            <input type="text" class="form-control" id="deviceName" name="custom_name" placeholder="e.g., Dad's iPhone, Living Room TV" required>
            <div class="form-text">Give this device a name you'll recognise</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Device Icon</label>
            <div class="icon-selector">
              {% for icon_name, icon_label in [('phone','Phone'),('tablet','Tablet'),('laptop','Laptop'),('pc-display','Desktop'),('tv','TV'),('speaker','Smart Speaker'),('controller','Game Console'),('smartwatch','Smartwatch'),('printer','Printer'),('router','Router/Network'),('house','Smart Home'),('question-circle','Other')] %}
              <div class="icon-option {% if icon_name == 'laptop' %}selected{% endif %}" data-icon="{{ icon_name }}" title="{{ icon_label }}">
                <i class="bi bi-{{ icon_name }}"></i>
              </div>
              {% endfor %}
            </div>
            <input type="hidden" name="icon" id="selectedIcon" value="laptop">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-aura btn-aura-outline" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-aura btn-aura-primary">
            <i class="bi bi-check2 me-1"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById('renameModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const mac  = button.getAttribute('data-mac');
    const name = button.getAttribute('data-name');
    const icon = button.getAttribute('data-icon') || 'laptop';

    document.getElementById('renameForm').action = '/device/' + encodeURIComponent(mac) + '/rename';
    document.getElementById('deviceName').value = name;
    document.getElementById('selectedIcon').value = icon;
    document.getElementById('iconPreview').innerHTML = '<i class="bi bi-' + icon + '"></i>';

    document.querySelectorAll('.icon-option').forEach(opt => {
      opt.classList.toggle('selected', opt.getAttribute('data-icon') === icon);
    });
  });

  document.querySelectorAll('.icon-option').forEach(option => {
    option.addEventListener('click', function () {
      const icon = this.getAttribute('data-icon');
      document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('selectedIcon').value = icon;
      document.getElementById('iconPreview').innerHTML = '<i class="bi bi-' + icon + '"></i>';
    });
  });
</script>
{% endblock %}
