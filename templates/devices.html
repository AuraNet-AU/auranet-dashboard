{% extends "base.html" %}

{% block container_width %}900px{% endblock %}
{% block content_width %}900px{% endblock %}

{% block extra_styles %}
  .device-card {
    background: #f8fafc;
    border-radius: 14px;
    padding: 1rem 1.25rem;
    margin-bottom: 0.625rem;
    transition: all 0.25s ease;
    border: 2px solid transparent;
  }

  .device-card:hover {
    border-color: rgba(99,102,241,0.2);
    box-shadow: 0 6px 20px rgba(99,102,241,0.1);
    transform: translateY(-1px);
    background: white;
  }

  .device-icon {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.375rem;
    flex-shrink: 0;
    color: white;
    transition: transform 0.25s ease;
  }

  .device-card:hover .device-icon { transform: scale(1.08); }

  .device-icon-high     { background: linear-gradient(135deg, #22c55e, #16a34a); }
  .device-icon-mid      { background: linear-gradient(135deg, #6366f1, #4f46e5); }
  .device-icon-low      { background: linear-gradient(135deg, #94a3b8, #64748b); }

  .device-name {
    font-weight: 700;
    color: #1e293b;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .device-name .edit-btn {
    opacity: 0;
    transition: opacity 0.2s;
    color: #94a3b8;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 0.875rem;
  }

  .device-card:hover .device-name .edit-btn { opacity: 1; }
  .device-name .edit-btn:hover { color: var(--aura-primary); }

  .device-meta { font-size: 0.8125rem; color: #64748b; margin-top: 0.125rem; }
  .device-meta .separator { margin: 0 0.5rem; color: #cbd5e1; }

  .device-badges {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    margin-top: 0.35rem;
    flex-wrap: wrap;
  }

  .device-activity {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.15rem 0.55rem;
    border-radius: 20px;
  }
  .activity-high   { background: #dcfce7; color: #16a34a; }
  .activity-mid    { background: #e0e7ff; color: #4338ca; }
  .activity-low    { background: #f1f5f9; color: #64748b; }

  .mode-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 0.15rem 0.55rem;
    border-radius: 20px;
  }
  .mode-badge-default  { background: #f1f5f9; color: #64748b; }
  .mode-badge-kids     { background: #dcfce7; color: #166534; }
  .mode-badge-family   { background: #ede9fe; color: #5b21b6; }
  .mode-badge-standard { background: #e0f2fe; color: #075985; }

  .settings-btn {
    display: inline-flex; align-items: center; gap: 0.35rem;
    padding: 0.45rem 0.9rem;
    border-radius: 8px; border: 2px solid #e2e8f0;
    background: white; color: #64748b;
    font-size: 0.8125rem; font-weight: 600;
    cursor: pointer; transition: all 0.2s; text-decoration: none;
    white-space: nowrap;
  }
  .settings-btn:hover {
    border-color: var(--aura-primary);
    color: var(--aura-primary);
    background: #eef2ff;
  }

  .info-box {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.25rem;
    border-left: 4px solid #3b82f6;
  }

  .info-box h4 { font-size: 0.9375rem; font-weight: 700; color: #1e40af; margin-bottom: 0.375rem; display: flex; align-items: center; }
  .info-box p { font-size: 0.8125rem; color: #1e3a8a; margin: 0; line-height: 1.5; }

  .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
  .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

  .modal-content { border-radius: 16px; border: none; }
  .modal-header { border-bottom: 1px solid #f1f5f9; padding: 1.25rem 1.5rem; }
  .modal-body { padding: 1.5rem; }
  .modal-footer { border-top: 1px solid #f1f5f9; padding: 1rem 1.5rem; }

  .form-label { font-weight: 600; color: #374151; font-size: 0.875rem; }

  .form-control {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    font-size: 0.9375rem;
  }

  .form-control:focus {
    border-color: var(--aura-primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .device-icon-preview {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: var(--aura-primary);
    margin: 0 auto 1rem;
  }

  .icon-selector { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center; margin-top: 0.75rem; }

  .icon-option {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
  }

  .icon-option:hover { border-color: var(--aura-primary); color: var(--aura-primary); }

  .icon-option.selected {
    border-color: var(--aura-primary);
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
    color: var(--aura-primary);
  }

  .mode-option {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .mode-option:hover {
    border-color: var(--aura-primary);
    background: #f8fafc;
  }

  .mode-option.selected {
    border-color: var(--aura-primary);
    background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
  }

  .mode-option-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
    flex-shrink: 0;
  }

  .mode-option-info h5 { font-size: 0.875rem; font-weight: 600; color: #1e293b; margin: 0; }
  .mode-option-info p { font-size: 0.75rem; color: #64748b; margin: 0; line-height: 1.3; }
{% endblock %}

{% set active_page = 'devices' %}

{% block content %}

  <div class="info-box">
    <h4><i class="bi bi-info-circle-fill me-2"></i>Your Connected Devices</h4>
    <p>
      Manage your devices below. Click <i class="bi bi-gear"></i> to rename a device or set its protection level.
      Devices without a specific mode use the network default set on the Home page
      {% if settings.protection_mode and settings.protection_mode != 'custom' and settings.protection_mode in modes %}
        (<strong>{{ modes[settings.protection_mode].name }}</strong>).
      {% else %}
        (<strong>Custom</strong>).
      {% endif %}
    </p>
  </div>

  <div class="aura-card">
    <div class="aura-card-header">
      <div class="header-icon" style="background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%); color: #2563eb;">
        <i class="bi bi-laptop"></i>
      </div>
      <h2>Network Devices</h2>
      <span class="badge bg-primary ms-auto" style="font-size: 0.75rem;">{{ devices|length }} devices</span>
    </div>
    <div class="aura-card-body">

      {% if devices %}
        {% for device in devices %}
        {% set activity = 'high' if device.queries > 1000 else 'mid' if device.queries > 100 else 'low' %}
        <div class="device-card">
          <div class="d-flex align-items-center gap-3">
            <div class="device-icon device-icon-{{ activity }}">
              <i class="bi bi-{{ device.icon if device.icon else 'laptop' }}"></i>
            </div>
            <div class="flex-grow-1 min-width-0">
              <div class="device-name">
                <span class="text-truncate">{{ device.custom_name if device.custom_name else device.name }}</span>
                <i class="bi bi-gear edit-btn"
                   data-bs-toggle="modal"
                   data-bs-target="#deviceModal"
                   data-mac="{{ device.mac }}"
                   data-name="{{ device.custom_name if device.custom_name else device.name }}"
                   data-icon="{{ device.icon if device.icon else 'laptop' }}"
                   data-mode="{{ device.mode or 'default' }}"
                   title="Device settings"></i>
              </div>
              <div class="device-meta">
                <span><i class="bi bi-hdd-network me-1"></i>{{ device.ip }}</span>
                {% if device.vendor and device.vendor != device.name and device.vendor != device.custom_name %}
                  <span class="separator">•</span>
                  <span>{{ device.vendor }}</span>
                {% endif %}
              </div>
              <div class="device-badges">
                <div class="device-activity activity-{{ activity }}">
                  <i class="bi bi-activity"></i>
                  {{ device.queries|short_num }} queries
                  {% if activity == 'high' %}&nbsp;· Active
                  {% elif activity == 'mid' %}&nbsp;· Moderate
                  {% else %}&nbsp;· Low activity{% endif %}
                </div>
                {% if device.mode and device.mode in modes %}
                  <span class="mode-badge mode-badge-{{ device.mode }}">
                    <i class="bi {{ modes[device.mode].icon }}"></i>
                    {{ modes[device.mode].name }}
                  </span>
                {% else %}
                  <span class="mode-badge mode-badge-default">
                    <i class="bi bi-globe2"></i>
                    Network Default
                  </span>
                {% endif %}
              </div>
            </div>
            <button class="settings-btn d-none d-md-inline-flex"
                    data-bs-toggle="modal"
                    data-bs-target="#deviceModal"
                    data-mac="{{ device.mac }}"
                    data-name="{{ device.custom_name if device.custom_name else device.name }}"
                    data-icon="{{ device.icon if device.icon else 'laptop' }}"
                    data-mode="{{ device.mode or 'default' }}">
              <i class="bi bi-gear"></i>Settings
            </button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="bi bi-wifi-off"></i>
          <h5>No Devices Found</h5>
          <p class="mb-0">Devices will appear here once they connect to your network and make DNS requests. This usually happens within a few minutes of the device connecting.</p>
        </div>
      {% endif %}

    </div>
  </div>

{% endblock %}

{% block scripts %}
<!-- DEVICE SETTINGS MODAL -->
<div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="deviceModalLabel">
          <i class="bi bi-gear me-2 text-primary"></i>Device Settings
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="" id="deviceForm">
        <div class="modal-body">
          <div class="device-icon-preview" id="iconPreview"><i class="bi bi-laptop"></i></div>

          <!-- Device Name -->
          <div class="mb-3">
            <label for="deviceName" class="form-label">Device Name</label>
            <input type="text" class="form-control" id="deviceName" name="custom_name" placeholder="e.g., Dad's iPhone, Living Room TV" required>
            <div class="form-text">Give this device a name you'll recognise</div>
          </div>

          <!-- Device Icon -->
          <div class="mb-4">
            <label class="form-label">Device Icon</label>
            <div class="icon-selector">
              {% for icon_name, icon_label in [('phone','Phone'),('tablet','Tablet'),('laptop','Laptop'),('pc-display','Desktop'),('tv','TV'),('speaker','Smart Speaker'),('controller','Game Console'),('smartwatch','Smartwatch'),('printer','Printer'),('router','Router/Network'),('house','Smart Home'),('question-circle','Other')] %}
              <div class="icon-option {% if icon_name == 'laptop' %}selected{% endif %}" data-icon="{{ icon_name }}" title="{{ icon_label }}">
                <i class="bi bi-{{ icon_name }}"></i>
              </div>
              {% endfor %}
            </div>
            <input type="hidden" name="icon" id="selectedIcon" value="laptop">
          </div>

          <!-- Protection Mode -->
          <div class="mb-2">
            <label class="form-label">Protection Level</label>
            <div class="form-text mb-2">Choose a protection level for this device, or use the network default.</div>
          </div>
          <div id="modeSelector">
            <div class="mode-option selected" data-mode="default" onclick="selectMode(this)">
              <div class="mode-option-icon" style="background: linear-gradient(135deg, #94a3b8, #64748b);">
                <i class="bi bi-globe2"></i>
              </div>
              <div class="mode-option-info">
                <h5>Network Default</h5>
                <p>Uses the protection level set on the Home page</p>
              </div>
            </div>
            {% for mode_id, mode in modes.items() %}
            <div class="mode-option" data-mode="{{ mode_id }}" onclick="selectMode(this)">
              <div class="mode-option-icon" style="background: linear-gradient(135deg, {{ mode.color }} 0%, {{ mode.color }}cc 100%);">
                <i class="bi {{ mode.icon }}"></i>
              </div>
              <div class="mode-option-info">
                <h5>{{ mode.name }}</h5>
                <p>{{ mode.description }}</p>
              </div>
            </div>
            {% endfor %}
          </div>
          <input type="hidden" name="mode" id="selectedMode" value="default">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-aura btn-aura-outline" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-aura btn-aura-primary">
            <i class="bi bi-check2 me-1"></i>Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.getElementById('deviceModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const mac  = button.getAttribute('data-mac');
    const name = button.getAttribute('data-name');
    const icon = button.getAttribute('data-icon') || 'laptop';
    const mode = button.getAttribute('data-mode') || 'default';

    document.getElementById('deviceForm').action = '/device/' + encodeURIComponent(mac) + '/settings';
    document.getElementById('deviceName').value = name;
    document.getElementById('selectedIcon').value = icon;
    document.getElementById('selectedMode').value = mode;
    document.getElementById('iconPreview').innerHTML = '<i class="bi bi-' + icon + '"></i>';

    document.querySelectorAll('.icon-option').forEach(opt => {
      opt.classList.toggle('selected', opt.getAttribute('data-icon') === icon);
    });

    document.querySelectorAll('.mode-option').forEach(opt => {
      opt.classList.toggle('selected', opt.getAttribute('data-mode') === mode);
    });
  });

  document.querySelectorAll('.icon-option').forEach(option => {
    option.addEventListener('click', function () {
      const icon = this.getAttribute('data-icon');
      document.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('selectedIcon').value = icon;
      document.getElementById('iconPreview').innerHTML = '<i class="bi bi-' + icon + '"></i>';
    });
  });

  function selectMode(el) {
    document.querySelectorAll('.mode-option').forEach(opt => opt.classList.remove('selected'));
    el.classList.add('selected');
    document.getElementById('selectedMode').value = el.getAttribute('data-mode');
  }
</script>
{% endblock %}
