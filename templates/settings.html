{% extends "base.html" %}

{% block container_width %}800px{% endblock %}
{% block content_width %}800px{% endblock %}

{% block extra_styles %}
  .settings-section-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #94a3b8;
    margin-bottom: 0.75rem;
    padding-left: 0.25rem;
  }

  .version-badge {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(135deg, var(--aura-primary) 0%, var(--aura-primary-dark) 100%);
    color: white;
    border-radius: 20px;
    padding: 0.35rem 0.875rem;
    font-size: 0.875rem;
    font-weight: 700;
  }

  .update-result {
    border-radius: 10px;
    padding: 0.875rem 1rem;
    font-size: 0.9rem;
    display: flex;
    align-items: flex-start;
  }

  .update-result.up-to-date { background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; }
  .update-result.update-available { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
  .update-result.update-error { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
  .update-result i { font-size: 1.1rem; margin-right: 0.625rem; flex-shrink: 0; margin-top: 0.1rem; }

  /* Full-screen updating overlay */
  .updating-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
  }

  .updating-panel {
    background: white;
    border-radius: 20px;
    padding: 2.5rem 2rem;
    text-align: center;
    max-width: 380px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .updating-spinner {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--aura-primary) 0%, var(--aura-primary-dark) 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto 1.25rem;
    animation: pulse-ring 2s ease-in-out infinite;
  }

  @keyframes pulse-ring {
    0%, 100% { box-shadow: 0 0 0 0 rgba(99,102,241,0.4); }
    50% { box-shadow: 0 0 0 12px rgba(99,102,241,0); }
  }

  .countdown-circle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #f1f5f9;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.375rem;
    font-weight: 700;
    color: var(--aura-primary);
    margin: 0.75rem auto 0;
  }

  .danger-zone {
    border: 1px solid #fee2e2;
    border-radius: 12px;
    padding: 1.25rem;
    background: #fff5f5;
  }

  .danger-zone h5 {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #dc2626;
    margin-bottom: 0.25rem;
  }

  .danger-zone p {
    font-size: 0.8125rem;
    color: #ef4444;
    margin: 0 0 0.875rem;
  }
{% endblock %}

{% block content %}
{% set active_page = 'settings' %}

<!-- Updating overlay (shown when ?updating=1) -->
<div class="updating-overlay d-none" id="updating-overlay">
  <div class="updating-panel">
    <div class="updating-spinner">
      <i class="bi bi-arrow-repeat" id="update-spinner-icon" style="animation: spin 1.5s linear infinite;"></i>
    </div>
    <h4 style="font-size:1.25rem;font-weight:700;color:#1e293b;margin-bottom:0.5rem;" id="overlay-title">Updating AuraNet...</h4>
    <p style="font-size:0.875rem;color:#64748b;margin-bottom:1rem;" id="overlay-message">Downloading the latest version. Please don't turn off your device.</p>
    <div class="countdown-circle" id="countdown-display">20</div>
    <p style="font-size:0.75rem;color:#94a3b8;margin-top:0.5rem;">Reloading automatically</p>
  </div>
</div>

<!-- ===== SOFTWARE CARD ===== -->
<p class="settings-section-title">Software</p>
<div class="aura-card mb-4">
  <div class="aura-card-header">
    <div class="header-icon" style="background:#ede9fe;"><i class="bi bi-arrow-up-circle" style="color:#7c3aed;"></i></div>
    <h2>Software Updates</h2>
  </div>
  <div class="aura-card-body">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
      <div>
        <div class="text-muted" style="font-size:0.8125rem;margin-bottom:0.375rem;">Current version</div>
        <span class="version-badge"><i class="bi bi-tag-fill me-1"></i>v{{ current_version }}</span>
      </div>
      <button onclick="checkForUpdates()" class="btn-aura btn-aura-outline" id="check-btn" style="padding:0.5rem 1.25rem;min-height:40px;font-size:0.875rem;">
        <i class="bi bi-cloud-arrow-down me-2"></i>Check for Updates
      </button>
    </div>

    <div id="update-result" class="d-none mb-3"></div>

    <form method="POST" action="{{ url_for('settings_update') }}" id="update-form" class="d-none">
      <button type="submit" class="btn-aura btn-aura-primary w-100">
        <i class="bi bi-arrow-up-circle me-2"></i>Update Now
      </button>
    </form>
  </div>
</div>

<!-- ===== TIMEZONE CARD ===== -->
<p class="settings-section-title">Regional</p>
<div class="aura-card mb-4">
  <div class="aura-card-header">
    <div class="header-icon" style="background:#e0f2fe;"><i class="bi bi-clock" style="color:#0284c7;"></i></div>
    <h2>Timezone</h2>
  </div>
  <div class="aura-card-body">
    <p style="font-size:0.875rem;color:#64748b;margin-bottom:1rem;">Used to calculate today's statistics correctly.</p>
    <form method="POST" action="{{ url_for('settings_timezone') }}">
      <div class="mb-3">
        <label class="form-label" style="font-size:0.875rem;font-weight:600;color:#374151;">Timezone</label>
        <select name="timezone" class="aura-select w-100">
          <optgroup label="Australia">
            {% for tz in au_timezones %}
            <option value="{{ tz }}" {% if tz == settings.get('timezone', 'Australia/Brisbane') %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
          </optgroup>
          <optgroup label="Other Timezones">
            {% for tz in other_timezones %}
            <option value="{{ tz }}" {% if tz == settings.get('timezone') %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
          </optgroup>
        </select>
      </div>
      <button type="submit" class="btn-aura btn-aura-primary" style="padding:0.6rem 1.5rem;min-height:44px;">
        <i class="bi bi-check me-2"></i>Save Timezone
      </button>
    </form>
  </div>
</div>

<!-- ===== ADVANCED CARD ===== -->
<p class="settings-section-title">Advanced</p>
<div class="aura-card mb-4">
  <div class="aura-card-header">
    <div class="header-icon" style="background:#fef3c7;"><i class="bi bi-gear" style="color:#d97706;"></i></div>
    <h2>Advanced Settings</h2>
  </div>
  <div class="aura-card-body">
    <div class="danger-zone">
      <h5><i class="bi bi-arrow-counterclockwise me-1"></i>Reset Setup Wizard</h5>
      <p>The setup wizard will run again the next time you visit the dashboard.</p>
      <button type="button" class="btn-aura btn-aura-danger" style="padding:0.5rem 1.25rem;min-height:40px;font-size:0.875rem;"
              data-bs-toggle="modal" data-bs-target="#resetModal">
        Reset Onboarding
      </button>
    </div>
  </div>
</div>

<!-- Reset confirmation modal -->
<div class="modal fade" id="resetModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;border:none;box-shadow:0 20px 60px rgba(0,0,0,0.15);">
      <div class="modal-body p-4 text-center">
        <div style="width:56px;height:56px;border-radius:50%;background:#fee2e2;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto 1rem;">
          <i class="bi bi-arrow-counterclockwise" style="color:#dc2626;"></i>
        </div>
        <h5 style="font-weight:700;margin-bottom:0.5rem;">Reset Setup Wizard?</h5>
        <p class="text-muted" style="font-size:0.875rem;">The onboarding wizard will run again the next time you visit the dashboard. Your protection settings and device names won't be changed.</p>
        <div class="d-flex gap-2 mt-3">
          <button type="button" class="btn-aura btn-aura-outline flex-fill" data-bs-dismiss="modal">Cancel</button>
          <form method="POST" action="{{ url_for('settings_reset_setup') }}" class="flex-fill">
            <button type="submit" class="btn-aura btn-aura-danger w-100">Reset</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
<script>
  // Show updating overlay if redirected back after update trigger
  const params = new URLSearchParams(window.location.search);
  if (params.get('updating') === '1') {
    showUpdatingOverlay();
  }

  function showUpdatingOverlay() {
    const overlay = document.getElementById('updating-overlay');
    overlay.classList.remove('d-none');

    let seconds = 20;
    const countdown = document.getElementById('countdown-display');
    countdown.textContent = seconds;

    const interval = setInterval(() => {
      seconds--;
      countdown.textContent = seconds;

      if (seconds <= 0) {
        clearInterval(interval);
        document.getElementById('overlay-title').textContent = 'Reconnecting...';
        document.getElementById('overlay-message').textContent = 'Almost done. Reloading the page now.';
        reloadWhenReady();
      }
    }, 1000);

    // Also poll for early completion
    pollUpdateStatus(interval);
  }

  function pollUpdateStatus(countdownInterval) {
    let attempts = 0;
    const poll = setInterval(() => {
      attempts++;
      fetch('/settings/update/status')
        .then(r => r.json())
        .then(data => {
          if (data.status === 'done' || data.status === 'error') {
            clearInterval(poll);
            clearInterval(countdownInterval);
            document.getElementById('countdown-display').textContent = '...';
            if (data.status === 'error') {
              document.getElementById('overlay-title').textContent = 'Update failed';
              document.getElementById('overlay-message').textContent = data.message || 'Something went wrong. The service is restarting.';
            }
            reloadWhenReady();
          }
        })
        .catch(() => {
          // Service is restarting â€” start reloading
          if (attempts > 3) {
            clearInterval(poll);
            clearInterval(countdownInterval);
            reloadWhenReady();
          }
        });
    }, 2000);
  }

  function reloadWhenReady() {
    document.getElementById('overlay-title').textContent = 'Reconnecting...';
    document.getElementById('overlay-message').textContent = 'Reloading the page...';
    const tryReload = setInterval(() => {
      fetch('/settings')
        .then(r => { if (r.ok) { clearInterval(tryReload); window.location.href = '/settings'; } })
        .catch(() => {});
    }, 2000);
    // Hard reload after 45s as a fallback
    setTimeout(() => { clearInterval(tryReload); window.location.href = '/settings'; }, 45000);
  }

  function checkForUpdates() {
    const btn = document.getElementById('check-btn');
    const resultDiv = document.getElementById('update-result');
    const updateForm = document.getElementById('update-form');

    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat me-2" style="animation:spin 1s linear infinite;display:inline-block;"></i>Checking...';
    resultDiv.className = 'd-none mb-3';
    updateForm.classList.add('d-none');

    fetch('/settings/check-update')
      .then(r => r.json())
      .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-arrow-down me-2"></i>Check for Updates';

        if (data.error) {
          resultDiv.className = 'update-result update-error mb-3';
          resultDiv.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i><div><strong>Could not check for updates.</strong><br><span style="font-size:0.8125rem;">' + data.error + '</span></div>';
        } else if (data.update_available) {
          resultDiv.className = 'update-result update-available mb-3';
          let html = '<i class="bi bi-arrow-up-circle-fill"></i><div>';
          html += '<strong>Update available: v' + data.latest + '</strong>';
          if (data.changelog) {
            html += '<br><span style="font-size:0.8125rem;margin-top:0.25rem;display:block;">' + data.changelog + '</span>';
          }
          html += '</div>';
          resultDiv.innerHTML = html;
          updateForm.classList.remove('d-none');
        } else {
          resultDiv.className = 'update-result up-to-date mb-3';
          resultDiv.innerHTML = '<i class="bi bi-check-circle-fill"></i><div><strong>You\'re up to date.</strong><br><span style="font-size:0.8125rem;">v' + data.current + ' is the latest version.</span></div>';
        }
        resultDiv.classList.remove('d-none');
      })
      .catch(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-arrow-down me-2"></i>Check for Updates';
        resultDiv.className = 'update-result update-error mb-3';
        resultDiv.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i><div><strong>Network error.</strong><br><span style="font-size:0.8125rem;">Make sure your AuraNet has internet access.</span></div>';
        resultDiv.classList.remove('d-none');
      });
  }
</script>
{% endblock %}
